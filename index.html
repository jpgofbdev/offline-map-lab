<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EauWare PMTiles Local Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="./style.css" />

<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>

</head>

<body>

<div id="landing" style="display:none; padding:70px 16px;">
  <h2 style="margin:0 0 8px 0;">Choisir une région</h2>
  <p style="margin:0 0 12px 0; color:#555;">Sélectionne une région pour afficher la carte.</p>
  <select id="landing-select" class="btn" style="width:100%;"></select>
  <button id="landing-go" class="btn" style="width:100%; margin-top:10px;">Ouvrir</button>
</div>

  

<div id="topbar">
  <div>Offline Map Lab</div>

  <div id="topbar-right">
    <button id="net-badge" class="badge">...</button>
  </div>
</div>

<div id="map"></div>

<div id="offline-drawer" class="drawer hidden">
  <div class="drawer-card">

    <div style="display:flex;justify-content:space-between;">
      <strong>Fond hors connexion</strong>
      <button id="drawer-close" class="btn">Fermer</button>
    </div>

    <div id="drawer-content"></div>

    <hr style="margin:16px 0;">

    <button id="reset-offline" class="btn"
            style="background:#fff0f0;border-color:#ffcccc;">
      Réinitialiser hors-ligne
    </button>

  </div>
</div>


<script src="./offline.js"></script>

<script>
  const params = new URLSearchParams(window.location.search);
  const pm = params.get("pm");

  if (!pm) {
    alert("Ajouter ?pm=CVL.pmtiles");
    throw new Error("Missing ?pm parameter");
  }

  const pmtilesUrl = pm.includes("://")
    ? pm
    : `https://tiles.jpg-cvl-dev.fr/tiles/${pm}`;

  const protocol = new pmtiles.Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

 const style = {
    version: 8,

    // nécessaire pour afficher du texte (labels)
    glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",

    sources: {
      basemap: {
        type: "vector",
        url: "pmtiles://" + pmtilesUrl
      }
    },

    layers: [
      // fond
      { id: "bg", type: "background", paint: { "background-color": "#ffffff" } },

      // eau (polygones)
      {
        id: "water",
        type: "fill",
        source: "basemap",
        "source-layer": "water",
        paint: { "fill-color": "#a0c8f0" }
      },

      // =========================
      // HYDRO - lignes
      // =========================

      // Fossés (ditch) + intermittents : plus clair + pointillé
      {
        id: "waterway_minor",
        type: "line",
        source: "basemap",
        "source-layer": "waterway",
        filter: ["any",
          ["==", ["get","class"], "ditch"],
          ["==", ["get","intermittent"], 1]
        ],
        paint: {
          "line-color": "#86bce8",
          "line-width": [
            "interpolate", ["linear"], ["zoom"],
            10, 0.9,
            12, 1.4,
            14, 2.2
          ],
          "line-dasharray": [1.5, 1.5]
        }
      },

      // Cours d'eau "normaux" (hors ditch et hors intermittents) : plus marqué
      {
        id: "waterway_main",
        type: "line",
        source: "basemap",
        "source-layer": "waterway",
        filter: ["all",
          ["!=", ["get","class"], "ditch"],
          ["==", ["get","intermittent"], 0]
        ],
        paint: {
          "line-color": "#2b7bbf",
          "line-width": [
            "interpolate", ["linear"], ["zoom"],
            6, 0.4,
            8, 0.8,
            10, 1.7,
            12, 2.6,
            14, 3.8
          ]
        }
      },

      // Labels fossés / intermittents (dès zoom 12)
      {
        id: "waterway_minor_label",
        type: "symbol",
        source: "basemap",
        "source-layer": "waterway",
        minzoom: 12,
        filter: ["all",
          ["has", "name"],
          ["any",
            ["==", ["get","class"], "ditch"],
            ["==", ["get","intermittent"], 1]
          ]
        ],
        layout: {
          "symbol-placement": "line",
          "text-field": ["get","name"],
          "text-size": [
            "interpolate", ["linear"], ["zoom"],
            12, 10,
            14, 11
          ],
          "text-max-angle": 45,
          "text-padding": 1,
          "text-allow-overlap": true,
          "text-ignore-placement": true
        },
        paint: {
          "text-color": "#4d93c8",
          "text-halo-color": "#ffffff",
          "text-halo-width": 2
        }
      },

      // Labels cours d'eau principaux (dès zoom 10)
      {
        id: "waterway_main_label",
        type: "symbol",
        source: "basemap",
        "source-layer": "waterway",
        minzoom: 10,
        filter: ["all",
          ["has", "name"],
          ["!=", ["get","class"], "ditch"],
          ["==", ["get","intermittent"], 0]
        ],
        layout: {
          "symbol-placement": "line",
          "text-field": ["get","name"],
          "text-size": [
            "interpolate", ["linear"], ["zoom"],
            10, 11,
            12, 12,
            14, 13
          ],
          "text-max-angle": 45,
          "text-padding": 1,
          "text-allow-overlap": true,
          "text-ignore-placement": true
        },
        paint: {
          "text-color": "#1f6fb3",
          "text-halo-color": "#ffffff",
          "text-halo-width": 2
        }
      },

      // =========================
      // ROUTES (en retrait)
      // =========================
      {
        id: "roads",
        type: "line",
        source: "basemap",
        "source-layer": "transportation",
        paint: {
          "line-color": "#888",
          "line-width": [
            "interpolate", ["linear"], ["zoom"],
            6, 0.3,
            10, 0.7,
            14, 1.3
          ]
        }
      },

      // Labels routes (plus tard)
      {
        id: "road_name",
        type: "symbol",
        source: "basemap",
        "source-layer": "transportation_name",
        minzoom: 13,
        layout: {
          "symbol-placement": "line",
          "text-field": ["coalesce", ["get","name:fr"], ["get","name"]],
          "text-size": 11
        },
        paint: {
          "text-color": "#444",
          "text-halo-color": "#ffffff",
          "text-halo-width": 1.5
        }
      },

      // Communes / lieux-dits
      {
        id: "place",
        type: "symbol",
        source: "basemap",
        "source-layer": "place",
        minzoom: 6,
        layout: {
          "text-field": ["coalesce", ["get","name:fr"], ["get","name"]],
          "text-size": [
            "interpolate", ["linear"], ["zoom"],
            6, 11,
            10, 14,
            14, 16
          ]
        },
        paint: {
          "text-color": "#111",
          "text-halo-color": "#ffffff",
          "text-halo-width": 1.6
        }
      }
    ]
  };


  const map = new maplibregl.Map({
    container: "map",
    style,
    center: [2.2, 46.7],
    zoom: 9
  });

  map.addControl(new maplibregl.NavigationControl(), "top-right");
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
  }
</script>

</body>
</html>
