<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Offline Map Lab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="./style.css" />
  <link rel="stylesheet" href="./maplibre-gl.css" />

  <script src="./maplibre-gl.js"></script>
  <script src="./pmtiles.js"></script>
</head>

<body>

<div id="topbar">
  <div id="topbar-left">
    <span id="app-title">Offline Map Lab</span>
    <select id="region-select" class="topbar-select"></select>
  </div>

  <div id="topbar-right">
    <button id="net-badge" class="badge">
      En ligne ¬∑ Hors-connexion : ‚Ä¶
    </button>
  </div>
</div>

<div id="landing">
  <h2>Choisir une r√©gion</h2>
  <p>S√©lectionne une r√©gion pour afficher la carte.</p>

  <div class="landing-row">
    <select id="landing-select" class="btn" style="flex:1;"></select>
    <button id="landing-go" class="btn btn-primary">Ouvrir</button>
  </div>

  <div class="landing-row" style="margin-top:10px;">
    <button id="landing-offline" class="btn">G√©rer le hors connexion</button>
  </div>
</div>

<div id="map"></div>

<div id="offline-drawer" class="drawer hidden">
  <div class="drawer-card">
    <div class="drawer-header">
      <div>
        <div class="drawer-title">Fond hors connexion</div>
        <div id="drawer-subtitle" class="drawer-subtitle"></div>
      </div>
      <button id="drawer-close" class="btn">Fermer</button>
    </div>

    <div id="drawer-content"></div>

    <hr style="margin:16px 0;">

    <button id="reset-offline" class="btn btn-danger">
      R√©initialiser hors-ligne
    </button>
  </div>
</div>

<script src="./offline.js"></script>

<script type="module">
import { initGPS, initViewPersistence, loadSavedView, GPSHelpers } from "./gps.js";
import { initOnlineCommuneSearch } from "./search-online.js";

(function initMap(){
  const params = new URLSearchParams(location.search);
  const pm = params.get("pm");
  if (!pm) return;

  document.getElementById("landing").style.display = "none";
  document.getElementById("map").style.display = "block";

  const pmtilesUrl = pm.includes("://")
    ? pm
    : `https://tiles.jpg-cvl-dev.fr/tiles/${pm}`;

  const regionCode = GPSHelpers.getRegionCodeFromPm(pm);
  const saved = loadSavedView(regionCode);

  const protocol = new pmtiles.Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  fetch("./style.json")
    .then(r => r.json())
    .then(style => {
      style.sources.basemap.url = "pmtiles://" + pmtilesUrl;

      const map = new maplibregl.Map({
        container: "map",
        style,
        center: saved ? [saved.lng, saved.lat] : [2.2, 46.7],
        zoom: saved ? saved.zoom : 9
      });

      map.addControl(new maplibregl.NavigationControl(), "top-right");

      // ‚úÖ Sauvegarde/restauration de vue par r√©gion
      initViewPersistence(map, regionCode);

      // ‚úÖ GPS (bouton flottant)
      initGPS(map, { buttonId: "gps-btn" });

      initOnlineCommuneSearch(map);

    })
    .catch(err => {
      console.error(err);
      alert("Erreur chargement style.json");
    });
})();
</script>


<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js");
}
</script>
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").then(reg => {

    // Force check update √† chaque chargement
    reg.update();

    reg.onupdatefound = () => {
      const newWorker = reg.installing;

      newWorker.onstatechange = () => {
        if (
          newWorker.state === "installed" &&
          navigator.serviceWorker.controller
        ) {
          console.log("Nouvelle version d√©tect√©e, rechargement...");
          window.location.reload();
        }
      };
    };
  });
}
</script>

<button id="search-open" class="btn-search" title="Rechercher une commune" aria-label="Rechercher une commune">üîç</button>


<button id="gps-btn" class="fab-gps" title="GPS : centrer sur ma position" aria-label="GPS : centrer sur ma position">
  ‚¶ø
</button>

<div id="search-drawer" class="drawer hidden">
  <div class="drawer-panel">
    <div class="drawer-header">
      <div class="drawer-title">Recherche commune (en ligne)</div>
      <button id="search-close" class="drawer-close" title="Fermer" aria-label="Fermer">‚úï</button>
    </div>

    <div class="drawer-body">
      <input id="search-input" class="search-input" type="text" placeholder="Commune (ex: Orl√©ans)" autocomplete="off" />
      <div id="search-status" class="search-status"></div>
      <div id="search-results" class="search-results"></div>
    </div>
  </div>
</div>


</body>
</html>
