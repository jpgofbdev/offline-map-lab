<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Offline Map Lab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="./style.css" />
  <link rel="stylesheet" href="./maplibre-gl.css" />

  <script src="./maplibre-gl.js"></script>
  <script src="./pmtiles.js"></script>
</head>

<body>

<!-- TOPBAR -->
<div id="topbar">
  <div id="topbar-left">
    <span id="app-title">Offline Map Lab</span>

    <select id="region-select" class="topbar-select" title="Choisir la région">
      <!-- rempli par offline.js -->
    </select>
  </div>

  <div id="topbar-right">
    <button id="net-badge" class="badge" type="button" title="Gérer le hors connexion">
      En ligne · Hors-connexion : …
    </button>
  </div>
</div>

<!-- LANDING si pas de ?pm= -->
<div id="landing">
  <h2>Choisir une région</h2>
  <p>Sélectionne une région pour afficher la carte. Tu peux aussi télécharger des régions pour un usage hors connexion.</p>

  <div class="landing-row">
    <select id="landing-select" class="btn" style="flex:1;"></select>
    <button id="landing-go" class="btn btn-primary">Ouvrir</button>
  </div>

  <div class="landing-row" style="margin-top:10px;">
    <button id="landing-offline" class="btn">Gérer le hors connexion</button>
  </div>
</div>

<!-- MAP -->
<div id="map"></div>

<!-- DRAWER OFFLINE -->
<div id="offline-drawer" class="drawer hidden" aria-hidden="true">
  <div class="drawer-card">
    <div class="drawer-header">
      <div>
        <div class="drawer-title">Fond hors connexion</div>
        <div id="drawer-subtitle" class="drawer-subtitle"></div>
      </div>
      <button id="drawer-close" class="btn">Fermer</button>
    </div>

    <div id="drawer-content"></div>

    <hr style="margin:16px 0;">

    <button id="reset-offline" class="btn btn-danger" type="button">
      Réinitialiser hors-ligne
    </button>

    <div class="small-note" style="margin-top:10px;">
      Astuce : une région téléchargée est servie en local même si le réseau est disponible.
    </div>
  </div>
</div>

<script src="./offline.js"></script>

<!-- INIT MAP (uniquement si ?pm= présent) -->
<script>
(function initMapIfPmPresent(){
  const params = new URLSearchParams(location.search);
  const pm = params.get("pm");

  // Pas de paramètre → pas de map (landing visible)
  if (!pm) return;

  // Afficher la map
  document.getElementById("landing").style.display = "none";
  document.getElementById("map").style.display = "block";

  const pmtilesUrl = pm.includes("://")
    ? pm
    : `https://tiles.jpg-cvl-dev.fr/tiles/${pm}`;

  const protocol = new pmtiles.Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  // Charge ton style existant (style.json)
  fetch("./style.json")
    .then(r => r.json())
    .then(style => {
      // On force la source basemap sur le PMTiles sélectionné
      style.sources = style.sources || {};
      style.sources.basemap = { type: "vector", url: "pmtiles://" + pmtilesUrl };

      const map = new maplibregl.Map({
        container: "map",
        style,
        center: [2.2, 46.7],
        zoom: 9
      });

      map.addControl(new maplibregl.NavigationControl(), "top-right");
    })
    .catch(err => {
      console.error("Erreur style.json:", err);
      alert("Erreur: style.json introuvable ou invalide.");
    });
})();
</script>

<!-- Register SW -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js");
}
</script>

</body>
</html>
