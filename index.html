<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EauWare PMTiles Local Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="./style.css" />

  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />

  <script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>
</head>

<body>

<div id="topbar">
  <div>Offline Map Lab</div>

  <div id="topbar-right">
    <button id="net-badge" class="badge">...</button>
  </div>
</div>

<div id="map"></div>

<div id="offline-drawer" class="drawer hidden">
  <div class="drawer-card">
    <div style="display:flex;justify-content:space-between;">
      <strong>Fond hors connexion</strong>
      <button id="drawer-close" class="btn">Fermer</button>
    </div>
    <div id="drawer-content"></div>
  </div>
</div>

<script src="./offline.js"></script>

<script>
  const params = new URLSearchParams(window.location.search);
  const pm = params.get("pm");

  if (!pm) {
    alert("Ajouter ?pm=CVL.pmtiles");
    throw new Error("Missing ?pm parameter");
  }

  const pmtilesUrl = pm.includes("://")
    ? pm
    : `https://tiles.jpg-cvl-dev.fr/tiles/${pm}`;

  const protocol = new pmtiles.Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  const style = {
    version: 8,
    glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
    sources: {
      basemap: {
        type: "vector",
        url: "pmtiles://" + pmtilesUrl
      }
    },
    layers: [
      { id: "bg", type: "background", paint: { "background-color": "#ffffff" } }
    ]
  };

  const map = new maplibregl.Map({
    container: "map",
    style,
    center: [2.2, 46.7],
    zoom: 9
  });

  map.addControl(new maplibregl.NavigationControl(), "top-right");
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
  }
</script>

</body>
</html>
