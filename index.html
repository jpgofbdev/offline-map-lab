<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Offline Map Lab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="./style.css" />
  <link rel="stylesheet" href="./maplibre-gl.css" />

  <script src="./maplibre-gl.js"></script>
  <script src="./pmtiles.js"></script>
</head>

<body>

<div id="topbar">
  <div id="topbar-left">
    <span id="app-title">Offline Map Lab</span>
    <select id="basemap-select" class="topbar-select" title="Fond de plan"></select>
    <select id="region-select" class="topbar-select"></select>
  </div>

  <div id="topbar-right">
    <button id="net-badge" class="badge">
      En ligne ¬∑ Hors-connexion : ‚Ä¶
    </button>
  </div>
</div>

<div id="landing">
  <h2>Choisir une r√©gion</h2>
  <p>S√©lectionne une r√©gion pour afficher la carte.</p>

  <div class="landing-row">
    <select id="landing-select" class="btn" style="flex:1;"></select>
    <button id="landing-go" class="btn btn-primary">Ouvrir</button>
  </div>

  <div class="landing-row" style="margin-top:10px;">
    <button id="landing-offline" class="btn">G√©rer le hors connexion</button>
  </div>
</div>

<div id="map"></div>

<div id="offline-drawer" class="drawer hidden">
  <div class="drawer-card">
    <div class="drawer-header">
      <div>
        <div class="drawer-title">Fond hors connexion</div>
        <div id="drawer-subtitle" class="drawer-subtitle"></div>
      </div>
      <button id="drawer-close" class="btn">Fermer</button>
    </div>

    <div id="drawer-content"></div>

    <hr style="margin:16px 0;">

    <button id="reset-offline" class="btn btn-danger">
      R√©initialiser hors-ligne
    </button>
  </div>
</div>

  <script src="./offline.js"></script>

<script type="module">
import { initGPS, initViewPersistence, loadSavedView, GPSHelpers } from "./gps.js";
import { initOnlineCommuneSearch } from "./search-online.js";
import { initBasemapMenu } from "./basemaps.js";

(function initMap(){
  const params = new URLSearchParams(location.search);
  const pm = params.get("pm");
  if (!pm) return;

  document.getElementById("landing").style.display = "none";
  document.getElementById("map").style.display = "block";

  const pmtilesUrl = pm.includes("://")
    ? pm
    : `https://tiles.jpg-cvl-dev.fr/tiles/${pm}`;

  const regionCode = GPSHelpers.getRegionCodeFromPm(pm);
  const saved = loadSavedView(regionCode);

  const protocol = new pmtiles.Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  Promise.all([
    fetch("./style.json?v=2026-02-16-1", { cache: "no-store" }).then(r => r.json()),
    fetch("./regions.json?v=2026-02-16-1", { cache: "no-store" }).then(r => r.json())
  ])
    .then(([style, reg]) => {
      style.sources.basemap.url = "pmtiles://" + pmtilesUrl;

      const regions = reg?.regions || [];
      const r = regions.find(x => x.code === regionCode);
      const regionCenter = r?.center;         // [lng, lat]
      const regionZoom = r?.zoom ?? 7;

      // Priorit√©s:
      // 1) vue sauvegard√©e (par r√©gion)
      // 2) centre/zoom par r√©gion (regions.json)
      // 3) fallback France
      const initialCenter = saved ? [saved.lng, saved.lat] : (regionCenter || [2.2, 46.7]);
      const initialZoom   = saved ? saved.zoom : (regionCenter ? regionZoom : 6);

      const map = new maplibregl.Map({
        container: "map",
        style,
        center: initialCenter,
        zoom: initialZoom
      });

      // ------------------------------
      // Basemaps
      // - PMTiles r√©gional (offline-first)
      // - PMTiles r√©gional (online)   (m√™me source pour l'instant, mais dissoci√© en UI)
      // - IGN Plan (raster)
      // - IGN Ortho (raster)
      // ------------------------------

      const basemapSelect = document.getElementById("basemap-select");
      if (basemapSelect && basemapSelect.options.length === 0) {
        const opts = [
          { id: "pmtiles-offline", label: "üü¶ PMTiles r√©gional (offline)" },
          { id: "pmtiles-online", label: "üåê PMTiles r√©gional (online)" },
          { id: "ign-plan-r", label: "üåê IGN Plan (raster)" },
          { id: "ign-ortho", label: "üåê IGN Ortho (raster)" }
        ];
        for (const o of opts) {
          const opt = document.createElement("option");
          opt.value = o.id;
          opt.textContent = o.label;
          basemapSelect.appendChild(opt);
        }
        basemapSelect.value = "pmtiles-offline";
      }

      function setPmtilesBasemapVisible(visible) {
        const st = map.getStyle();
        if (!st?.layers) return;
        for (const lyr of st.layers) {
          if (lyr.source === "basemap") {
            try { map.setLayoutProperty(lyr.id, "visibility", visible ? "visible" : "none"); }
            catch { /* ignore */ }
          }
        }
      }

      function ensureIgnRasterLayers() {
        const beforeId = map.getStyle()?.layers?.[0]?.id;

        // Ortho (WMTS raster) ‚Äì TileMatrixSet PM_0_19 (mise √† jour IGN 2025)
        if (!map.getSource("ign-ortho")) {
          map.addSource("ign-ortho", {
            type: "raster",
            tiles: [
              "https://data.geopf.fr/wmts?service=WMTS&request=GetTile&version=1.0.0" +
              "&layer=ORTHOIMAGERY.ORTHOPHOTOS&style=normal&format=image/jpeg" +
              "&tilematrixset=PM_0_19&tilematrix={z}&tilecol={x}&tilerow={y}"
            ],
            tileSize: 256,
            maxzoom: 19
          });
        }
        if (!map.getLayer("basemap-ign-ortho")) {
          map.addLayer({
            id: "basemap-ign-ortho",
            type: "raster",
            source: "ign-ortho",
            layout: { visibility: "none" }
          }, beforeId);
        }

        // Plan IGN (WMTS raster) ‚Äì ressource "d√©couverte" : GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2
        if (!map.getSource("ign-plan-r")) {
          map.addSource("ign-plan-r", {
            type: "raster",
            tiles: [
              "https://data.geopf.fr/wmts?service=WMTS&request=GetTile&version=1.0.0" +
              "&layer=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&style=normal&format=image/png" +
              "&tilematrixset=PM&tilematrix={z}&tilecol={x}&tilerow={y}"
            ],
            tileSize: 256,
            maxzoom: 19
          });
        }
        if (!map.getLayer("basemap-ign-plan-r")) {
          map.addLayer({
            id: "basemap-ign-plan-r",
            type: "raster",
            source: "ign-plan-r",
            layout: { visibility: "none" }
          }, beforeId);
        }
      }

      function setRasterBasemapVisibility(which) {
        // which: "none" | "plan" | "ortho"
        if (map.getLayer("basemap-ign-plan-r")) {
          map.setLayoutProperty("basemap-ign-plan-r", "visibility", which === "plan" ? "visible" : "none");
        }
        if (map.getLayer("basemap-ign-ortho")) {
          map.setLayoutProperty("basemap-ign-ortho", "visibility", which === "ortho" ? "visible" : "none");
        }
      }

      function setBasemap(id) {
        // Note: on dissocie offline/online en UI. Aujourd'hui c'est le m√™me PMTiles,
        // mais √ßa te laisse la place d'ajouter plus tard un PMTiles "online" distinct.
        if (id === "pmtiles-offline" || id === "pmtiles-online") {
          ensureIgnRasterLayers();
          setRasterBasemapVisibility("none");
          setPmtilesBasemapVisible(true);

          // Drawer offline pertinent uniquement pour pmtiles-offline
          const badge = document.getElementById("net-badge");
          if (badge) {
            const ok = (id === "pmtiles-offline");
            badge.disabled = !ok;
            badge.style.opacity = ok ? 1 : 0.6;
            badge.title = ok
              ? "Appuyer pour g√©rer les r√©gions hors connexion"
              : "Fond PMTiles en ligne : gestion hors connexion d√©sactiv√©e";
          }
          return;
        }

        if (id === "ign-plan-r" || id === "ign-ortho") {
          ensureIgnRasterLayers();
          setPmtilesBasemapVisible(false);
          setRasterBasemapVisibility(id === "ign-plan-r" ? "plan" : "ortho");

          const badge = document.getElementById("net-badge");
          if (badge) {
            badge.disabled = true;
            badge.style.opacity = 0.6;
            badge.title = "Fond en ligne (IGN) : hors connexion g√©r√© uniquement pour le fond PMTiles";
          }
        }
      }

      map.on("load", () => {
        ensureIgnRasterLayers();
        setBasemap(basemapSelect?.value || "pmtiles-offline");
        basemapSelect?.addEventListener("change", () => setBasemap(basemapSelect.value));
      });

const isMobile = matchMedia("(max-width: 520px)").matches;
if (!isMobile) {
  map.addControl(new maplibregl.NavigationControl(), "top-right");
}

      // ‚úÖ Sauvegarde/restauration de vue par r√©gion
      initViewPersistence(map, regionCode);

      // ‚úÖ GPS (bouton flottant)
      initGPS(map, { buttonId: "gps-btn" });

      // ‚úÖ Recherche commune (en ligne)
      initOnlineCommuneSearch(map);

      // ‚úÖ Menu fonds de plan (PMTiles offline/online + IGN raster)
      initBasemapMenu(map);
    })
    .catch(err => {
      console.error(err);
      alert("Erreur chargement style.json / regions.json");
    });
})();
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js");
}
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").then(reg => {
    // Force check update √† chaque chargement
    reg.update();

    reg.onupdatefound = () => {
      const newWorker = reg.installing;
      newWorker.onstatechange = () => {
        if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
          console.log("Nouvelle version d√©tect√©e, rechargement...");
          window.location.reload();
        }
      };
    };
  });
}
</script>

<button id="search-open" class="btn-search" title="Rechercher une commune" aria-label="Rechercher une commune">üîç</button>

<button id="gps-btn" class="fab-gps" title="GPS : centrer sur ma position" aria-label="GPS : centrer sur ma position">
  ‚¶ø
</button>

<div id="search-drawer" class="drawer hidden">
  <div class="drawer-panel">
    <div class="drawer-header">
      <div class="drawer-title">Recherche commune (en ligne)</div>
      <button id="search-close" class="drawer-close" title="Fermer" aria-label="Fermer">‚úï</button>
    </div>

    <div class="drawer-body">
      <input id="search-input" class="search-input" type="text" placeholder="Commune (ex: Orl√©ans)" autocomplete="off" />
      <div id="search-status" class="search-status"></div>
      <div id="search-results" class="search-results"></div>
    </div>
  </div>
</div>

</body>
</html>